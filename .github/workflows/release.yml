name: Release

on:
  push:
    branches:
      - distribution
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 0.0.1)'
        required: false
        type: string

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set VERSION env var
        run: |
          VERSION="${{ github.event.inputs.version || github.ref_name }}"
          echo "VERSION=${VERSION#v}" >> $GITHUB_ENV

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Fetch Babelfish Asset
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release download --repo arosov/babelfish -p "babelfish.zip" --output babelfish.zip
          echo "BABELFISH_ZIP=$(pwd)/babelfish.zip" >> $GITHUB_ENV
          
      - name: Bundle Babelfish
        run: ./gradlew :composeApp:bundleBabelfish

      - name: Build with Gradle
        run: ./gradlew :composeApp:packageUberJarForCurrentOS

      - name: Build AppImage
        run: ./gradlew :composeApp:packageAppImage

      - name: Generate Download Page
        run: ./gradlew :composeApp:generateDownloadPage

      - name: Restore Conveyor Cache
        uses: actions/cache/restore@v4
        with:
          path: .conveyor
          key: conveyor-${{ runner.os }}-${{ hashFiles('conveyor.conf', 'composeApp/build.gradle.kts') }}
          restore-keys: |
            conveyor-${{ runner.os }}-

      - name: Build Site with Conveyor
        uses: hydraulic-software/conveyor/actions/build@v21.1
        env:
          OAUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          command: make site --overwrite
          agree_to_license: 1
          signing_key: ${{ secrets.SIGNING_KEY }}

      - name: Publish with Conveyor
        uses: hydraulic-software/conveyor/actions/build@v21.1
        env:
          OAUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          command: make copied-site --overwrite
          agree_to_license: 1
          signing_key: ${{ secrets.SIGNING_KEY }}

      - name: Save Conveyor Cache
        if: always()
        uses: actions/cache/save@v4
        with:
          path: .conveyor
          key: conveyor-${{ runner.os }}-${{ hashFiles('conveyor.conf', 'composeApp/build.gradle.kts') }}-${{ github.run_id }}

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: distributions
          path: output/

      - name: Update Release Notes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG_NAME="v$VERSION"
          echo "Target Release Tag: $TAG_NAME"
          
          # Ensure release exists (create if missing)
          gh release create "$TAG_NAME" --title "$TAG_NAME" --generate-notes || echo "Release $TAG_NAME likely exists, proceeding to update notes"

          BABELFISH_VER=$(cat composeApp/src/jvmMain/resources/babelfish_version.txt)
          gh release view "$TAG_NAME" --json body --jq .body > release_body.md
          echo -e "\n\n### Bundled Components\n- Babelfish v$BABELFISH_VER" >> release_body.md
          gh release edit "$TAG_NAME" --notes-file release_body.md